<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>

    <!-- import the d3 library -->
    <!-- <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script> -->
    <script type='text/javascript' src='lib/d3.v5.min.js'></script>

    <!-- style sheet -->
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <svg id="scene">
        <g id='links'></g>
        <g id='labels'></g>
        <g id='nodes'></g>
    </svg>

    <script>
        let width = 1250,
            height = 1050,
            svg = d3.select('#scene').attr("width", width).attr("height", height);
        let persons;
        let yScale;
        let xScale;
        let colorScale;
        let tailleScale;


        d3.json("data.json").then(data => {
            persons = data.persons

            yScale = d3.scaleLinear()
                .domain([0, d3.max(persons, d => d.position.y)])
                .range([height, 0]); // seems backwards because SVG is y-down

            xScale = d3.scaleLinear()
                .domain([0, d3.max(persons, d => d.position.x)])
                .range([0, width]);

            colorScale = d3.scaleThreshold()
                .domain([10, 20, 30, 50, 70, 80])
                .range(d3.schemeBlues[6]);

            tailleScale = d3.scaleThreshold()
                .domain([150, 160, 170, 180, 190, 200])
                .range([9, 10, 12, 13, 14, 15]);

            let personsPasPermis = persons.filter(d => d.permisArme === "non");
            svg.selectAll('circle')
                .data(personsPasPermis)
                .enter()
                .append('circle') // create a circle in the svg
                .attr("stroke-width", 2) // with attributes ...
                .attr("cx", d => xScale(d.position.x))
                .attr("cy", d => yScale(d.position.y))
                .attr('stroke', 'black')
                .attr("r", d => tailleScale(d.taille))
                .attr("fill", d => colorScale(d.age))

            let personsPermis = persons.filter(d => d.permisArme === "oui");
            let triangleSymbol = d3.symbol().type(d3.symbolTriangle).size(d => (tailleScale(d.taille) * 30));
            svg.selectAll('path.triangle')
                .data(personsPermis)
                .enter()
                .append('path')
                .attr("transform", d => `translate(${xScale(d.position.x)}, ${yScale(d.position.y)})`)
                .attr('d', triangleSymbol)
                .attr("stroke-width", 2)
                .attr('stroke', 'black')
                .attr('fill', d => colorScale(d.age));


            let labelGroup = svg.selectAll('g.person')
                .data(persons)
                .enter()
                .append('g')
                .attr('class', 'person')
                .attr('transform', d => `translate(${xScale(d.position.x) + 7}, ${yScale(d.position.y)})`)

            labelGroup.append('rect')
                .attr('width', d => d.name.length * 10 + 5)
                .attr('stroke-width', 2)
                .attr('stroke', 'black')
                .attr('height', 17)
                .attr('fill', 'white')

            labelGroup.append('text')
                .text(d => d.name)
                .attr('y', 13)
                .attr('x', d => d.name.length * 10 + 2)
                .attr('fill', 'black')
                .attr('text-anchor', 'end')
                .attr("font-size", ".8em")

            labelGroup.append('text')
                .text(d => d.age)
                .attr('y', 4.5)
                .attr('x', 0)
                .attr('text-anchor', 'end')
                .attr("font-size", ".8em")


            let family_links = data["family-links"];
            let links = data["links"];

            let linkScale = d3.scaleOrdinal()
                .domain(["travail", "voisin"])
                .range(["black","brown"]);

            let family_linkScale = d3.scaleOrdinal()
                .domain(["enfant", "conjoint", "ex", "soeur"])
                .range(["green", "purple", "red", "orange"]);


            // Dessiner les lignes pour relier les éléments
            svg.selectAll('line.link')
                .data(links)
                .enter()
                .append('line')
                .attr("class", "link") // Ajouter une classe pour les lignes
                .attr("x1", d => {
                    // Trouver les coordonnées x du point de départ (source) en fonction du nom de la source
                    let sourcePerson = persons.find(person => person.name === d.source);
                    return xScale(sourcePerson.position.x);
                })
                .attr("y1", d => {
                    // Trouver les coordonnées y du point de départ (source) en fonction du nom de la source
                    let sourcePerson = persons.find(person => person.name === d.source);
                    return yScale(sourcePerson.position.y);
                })
                .attr("x2", d => {
                    // Trouver les coordonnées x du point d'arrivée (cible) en fonction du nom de la cible
                    let targetPerson = persons.find(person => person.name === d.target);
                    return xScale(targetPerson.position.x);
                })
                .attr("y2", d => {
                    // Trouver les coordonnées y du point d'arrivée (cible) en fonction du nom de la cible
                    let targetPerson = persons.find(person => person.name === d.target);
                    return yScale(targetPerson.position.y);
                })
                .attr("stroke", d => linkScale(d.relation))
                .attr("stroke-width", 2);

            //Family
            // Dessiner les lignes pour relier les éléments
            svg.selectAll('line.familylink')
                .data(family_links)
                .enter()
                .append('line')
                .attr("class", "familylink") // Ajouter une classe pour les lignes
                .attr("x1", d => {
                    // Trouver les coordonnées x du point de départ (source) en fonction du nom de la source
                    let sourcePerson = persons.find(person => person.name === d.source);
                    return xScale(sourcePerson.position.x);
                })
                .attr("y1", d => {
                    // Trouver les coordonnées y du point de départ (source) en fonction du nom de la source
                    let sourcePerson = persons.find(person => person.name === d.source);
                    return yScale(sourcePerson.position.y);
                })
                .attr("x2", d => {
                    // Trouver les coordonnées x du point d'arrivée (cible) en fonction du nom de la cible
                    let targetPerson = persons.find(person => person.name === d.target);
                    return xScale(targetPerson.position.x);
                })
                .attr("y2", d => {
                    // Trouver les coordonnées y du point d'arrivée (cible) en fonction du nom de la cible
                    let targetPerson = persons.find(person => person.name === d.target);
                    return yScale(targetPerson.position.y);
                })
                .attr("stroke", d => family_linkScale(d.relation))
                .attr("stroke-width", 2);


        })
    </script>

</body>

</html>